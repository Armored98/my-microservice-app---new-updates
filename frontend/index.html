{% extends "base.html" %}
{% block body %}
<div class="row justify-content-center">
	<div class="col-md-8">
		<div class="card shadow-sm">
			<div class="card-body">
				<h3 class="card-title mb-4">Your Todos</h3>
				{% if not session.get('token') %}
					<div class="alert alert-info">
						Plz <a href="{{ url_for('login') }}" class="alert-link">log in</a> to manage your todos.
					</div>
						{% else %}
							<div class="d-flex justify-content-between align-items-center mb-2">
								<h5 class="mb-0">Todo List</h5>
								<a href="{{ url_for('export') }}" class="btn btn-outline-secondary btn-sm">Export</a>
							</div>
							<ul class="list-group mb-4">
								{% for todo in todos %}
									<li class="list-group-item d-flex justify-content-between align-items-center">
										<form method="post" class="d-flex align-items-center w-100" style="gap: 10px;">
											<input type="hidden" name="toggle_id" value="{{ todo.id }}">
											<input type="hidden" name="done" value="{{ 0 if todo.done else 1 }}">
											<input class="form-check-input me-2" type="checkbox" onchange="this.form.submit()" {% if todo.done %}checked{% endif %}>
											<span {% if todo.done %}style="text-decoration: line-through; color: #888;"{% endif %}>{{ todo.task }}</span>
										</form>
										<div class="d-flex align-items-center" style="gap: 5px;">
											{% for prio, color, title in [(1, '#dc3545', 'High'), (2, '#ffc107', 'Medium'), (3, '#28a745', 'Low')] %}
											<form method="post" onsubmit="setTimeout(function(){window.location.reload();}, 100);">
												<input type="hidden" name="toggle_id" value="{{ todo.id }}">
												<input type="hidden" name="priority" value="{{ prio }}">
												<button type="submit" class="btn p-0 border-0 bg-transparent" title="{{ title }} priority">
													<span style="display:inline-block;width:18px;height:18px;border-radius:50%;background-color:{{ color }};border:2px solid {{ color }};{{ 'box-shadow:0 0 0 2px ' ~ color if todo.priority==prio else 'opacity:0.3;' }}"></span>
												</button>
											</form>
											{% endfor %}
										</div>
									</li>
								{% else %}
									<li class="list-group-item text-muted">No todos yet.</li>
								{% endfor %}
							</ul>
							<form method="post" class="d-flex align-items-center" style="gap: 10px;" id="add-todo-form">
								<input type="text" name="task" class="form-control me-2" placeholder="New Todo" required>
								<div class="d-flex align-items-center" style="gap: 5px;">
									<label class="me-1">Priority:</label>
									<input type="radio" name="priority" value="1" id="prio-high" class="form-check-input visually-hidden" required>
									<label for="prio-high" class="me-1 prio-label" title="High"><span id="circle-high" style="display:inline-block;width:18px;height:18px;border-radius:50%;background-color:#dc3545;border:2px solid #dc3545;"></span></label>
									<input type="radio" name="priority" value="2" id="prio-med" class="form-check-input visually-hidden">
									<label for="prio-med" class="me-1 prio-label" title="Medium"><span id="circle-med" style="display:inline-block;width:18px;height:18px;border-radius:50%;background-color:#ffc107;border:2px solid #ffc107;"></span></label>
									<input type="radio" name="priority" value="3" id="prio-low" class="form-check-input visually-hidden">
									<label for="prio-low" class="prio-label" title="Low"><span id="circle-low" style="display:inline-block;width:18px;height:18px;border-radius:50%;background-color:#28a745;border:2px solid #28a745;"></span></label>
								</div>
								<button type="submit" class="btn btn-primary">Add</button>
							</form>
							<script>
							// Highlight selected priority circle
							document.addEventListener('DOMContentLoaded', function() {
								const form = document.getElementById('add-todo-form');
								const radios = form.querySelectorAll('input[name="priority"]');
								const circles = {
									'1': document.getElementById('circle-high'),
									'2': document.getElementById('circle-med'),
									'3': document.getElementById('circle-low')
								};
								function updateHighlight() {
									radios.forEach(radio => {
										if (radio.checked) {
											circles[radio.value].style.boxShadow = '0 0 0 2px ' + circles[radio.value].style.backgroundColor;
										} else {
											circles[radio.value].style.boxShadow = 'none';
										}
									});
								}
								radios.forEach(radio => {
									radio.addEventListener('change', updateHighlight);
								});
								updateHighlight();
							});
							</script>
				{% endif %}
			</div>
		</div>
	</div>
</div>
{% endblock %}
